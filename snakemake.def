Bootstrap: docker
From: continuumio/miniconda3



%post
	### Installs snakemake and s3cmd 

	PATH=/opt/conda/bin:$PATH
        export PATH	
	conda install -c conda-forge mamba
	mamba create -c conda-forge -c bioconda -n snakemake snakemake -y
	pip install s3cmd
	chmod 777 /opt/s3_cfg

	### Creates a bash script which sources access key and secret key to S3 from config.sh. 	

	echo \#\!/bin/bash > /opt/runscript.sh
	echo source activate snakemake >> /opt/runscript.sh
	echo source config.sh >> /opt/runscript.sh
	echo s3cmd --access_key=\$akey --secret_key=\$skey --version >> /opt/runscript.sh
	echo s3cmd --access_key=\$akey --secret_key=\$skey -c /opt/s3_cfg ls s3://ctmr-test/ >> /opt/runscript.sh
	echo \$\@ >> /opt/runscript.sh

%files
	### Copies Snakefile to /opt/hej and .s3cfg to /opt/s3_cfg

	Snakefile /opt/hej
	~/.s3cfg /opt/s3_cfg


%runscript
	### Starts runscript.sh, everything you type after "sing run snakemake.sif" is forwarded to the runscript.
	### e.g. "sing run snakemake.sif snakemake --snakefile /opt/hej --dryrun" forwards "snakemake --snakefile 
	### /opt/hej --dryrun" to runscript.sh and executes that command. 

	bash /opt/runscript.sh "$@"
	echo "$@"
